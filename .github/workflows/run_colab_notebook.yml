name: Run Colab Notebook Daily (via nbconvert)

on:
  workflow_dispatch: # Allows manual trigger from GitHub UI
  schedule:
    # Runs every day at 03:00 AM UTC (Coordinated Universal Time)
    # Adjust the '0 3' to your desired hour (0-23) and minute (0-59) in UTC.
    - cron: '0 3 * * *'

jobs:
  run-notebook-via-nbconvert: # Job name changed for clarity
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Set a reasonable timeout, e.g., 60 minutes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Service Account Key File
        # This step creates the service_account_key.json file from a GitHub Secret.
        # Ensure you have a repository secret named SERVICE_ACCOUNT_JSON_KEY
        # containing the full JSON content of your service account key file.
        run: |
          echo "${{ secrets.SERVICE_ACCOUNT_JSON_KEY }}" > service_account_key.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # Recommended stable Python 3 version

      - name: Install dependencies
        run: |
          # Install necessary libraries for your script
          pip install pandas requests google-auth google-api-python-client urllib3 openpyxl
          # Install nbconvert and jupyter (required for nbconvert execution)
          pip install nbconvert jupyter

      - name: Run Colab Notebook (using nbconvert)
        run: |
          # Execute the notebook using nbconvert
          # --to notebook: output format is a notebook (executed version)
          # --execute: execute all cells
          # --inplace: overwrite the original notebook with the executed version
          jupyter nbconvert --to notebook --execute --inplace gg_sheet.ipynb

      - name: Commit executed notebook (Optional: for debugging/history)
        # This step commits the executed notebook back to the repository.
        # It's useful for seeing output directly in GitHub.
        # If you don't want this, you can remove this entire step.
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated: Executed Colab notebook via GitHub Actions"
          branch: main # Or your default branch if different
          file_pattern: 'gg_sheet.ipynb' # Only commit the notebook file
